version: '3.8'

services:
  dashboard:
    image: node:20-alpine
    container_name: clara-dashboard
    ports:
      - "8081:3000"
    networks:
      - dashboard-network
    restart: unless-stopped
    volumes:
      - /Users/nora/.openclaw-backups:/backups:ro
    entrypoint: ["/bin/sh", "-c"]
    command:
      - |
        cd /tmp
        cat > package.json << 'EOF'
        {"dependencies":{"express":"^4.18.2"}}
        EOF
        npm install --silent
        cat > server.js << 'EOF'
        const express = require("express");
        const app = express();
        const PORT = 3000;

        app.get("/api/health", (req, res) => {
          res.json({ status: "healthy", timestamp: new Date().toISOString() });
        });

        app.get("/api/cron-status", (req, res) => {
          res.json({
            status: "running",
            activeJobs: 6,
            jobs: [
              { name: "Morning Text", schedule: "7:30 AM Mon-Fri", status: "active" },
              { name: "Morning Email", schedule: "8:00 AM Mon-Fri", status: "active" },
              { name: "Saturday Light", schedule: "7:30 AM Sat", status: "active" },
              { name: "Sunday Week Ahead", schedule: "7:00 PM Sun", status: "active" },
              { name: "Outlook Token Refresh", schedule: "Every 45 min", status: "active" },
              { name: "Email Check", schedule: "Every 20 min", status: "active" }
            ]
          });
        });

        app.get("/api/backup-status", async (req, res) => {
          const fs = require('fs').promises;
          const path = require('path');
          try {
            const backupDir = '/backups';
            const files = await fs.readdir(backupDir);
            const backupFiles = files.filter(f => f.endsWith('.tar.gz'));
            const fileStats = await Promise.all(
              backupFiles.map(async (file) => {
                const stats = await fs.stat(path.join(backupDir, file));
                return { name: file, mtime: stats.mtime, size: stats.size };
              })
            );
            fileStats.sort((a, b) => b.mtime - a.mtime);
            const lastBackup = fileStats[0];
            res.json({
              status: "healthy",
              lastBackup: lastBackup ? lastBackup.mtime.toISOString().replace('T', ' ').substring(0, 16) : "Unknown",
              totalBackups: backupFiles.length,
              size: lastBackup ? Math.round(lastBackup.size / 1024) + " KB" : "0 KB"
            });
          } catch (e) {
            res.json({ status: "error", lastBackup: "Unknown", error: e.message });
          }
        });

        app.get("/", (req, res) => {
          res.send(`<!DOCTYPE html>
          <html><head><title>Clara Dashboard</title>
          <meta name="viewport" content="width=device-width, initial-scale=1">
          <style>
          *{box-sizing:border-box}
          body{font-family:-apple-system,BlinkMacSystemFont,sans-serif;margin:0;padding:20px;background:#1a1a2e;color:#eee}
          h1{color:#667eea;text-align:center;margin-bottom:30px}
          .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(300px,1fr));gap:20px;max-width:1200px;margin:0 auto}
          .card{background:#16213e;border-radius:12px;padding:20px;border:1px solid #0f3460}
          .card h2{margin:0 0 15px 0;color:#e94560;font-size:1.1em;display:flex;align-items:center;gap:8px}
          .dot{width:10px;height:10px;border-radius:50%;background:#22c55e;animation:pulse 2s infinite}
          @keyframes pulse{0%,100%{opacity:1}50%{opacity:.5}}
          ul{list-style:none;padding:0;margin:0}
          li{padding:8px 0;border-bottom:1px solid #0f3460;font-size:0.9em}
          li:last-child{border:none}
          .label{color:#888}
          </style></head>
          <body>
          <h1>Clara Dashboard</h1>
          <div class="grid">
            <div class="card">
              <h2><span class="dot"></span>System Health</h2>
              <p><span class="label">Status:</span> <span id="health">Loading...</span></p>
              <p><span class="label">Updated:</span> <span id="time">-</span></p>
            </div>
            <div class="card">
              <h2><span class="dot"></span>Cron Jobs</h2>
              <ul id="cron"><li>Loading...</li></ul>
            </div>
            <div class="card">
              <h2><span class="dot"></span>Backup Status</h2>
              <p><span class="label">Status:</span> <span id="backup">Loading...</span></p>
              <p><span class="label">Last:</span> <span id="last">-</span></p>
            </div>
          </div>
          <script>
          async function load(){
            try {
              const h=await fetch("/api/health").then(r=>r.json());
              document.getElementById("health").textContent=h.status;
              document.getElementById("time").textContent=new Date().toLocaleString();
            } catch(e) { document.getElementById("health").textContent="error"; }
            try {
              const c=await fetch("/api/cron-status").then(r=>r.json());
              document.getElementById("cron").innerHTML=c.jobs.map(j=>"<li><strong>"+j.name+"</strong><br><span class='label'>"+j.schedule+"</span></li>").join("");
            } catch(e) {}
            try {
              const b=await fetch("/api/backup-status").then(r=>r.json());
              document.getElementById("backup").textContent=b.status;
              document.getElementById("last").textContent=b.lastBackup;
            } catch(e) {}
          }
          load();setInterval(load,30000);
          </script></body></html>`);
        });

        app.listen(PORT, "0.0.0.0", () => console.log("Dashboard running on port " + PORT));
        EOF
        exec node server.js
    healthcheck:
      test: ["CMD", "wget", "-q", "-O-", "http://localhost:3000/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

networks:
  dashboard-network:
    driver: bridge
