version: '3.8'

services:
  dashboard:
    image: node:20-alpine
    container_name: clara-dashboard
    ports:
      - "8081:3000"
    networks:
      - dashboard-network
    restart: unless-stopped
    volumes:
      - /Users/nora/.openclaw-backups:/backups:ro
    environment:
      - NODE_ENV=production
      - PORT=3000
    entrypoint: ["/bin/sh", "-c"]
    command:
      - |
        cd /tmp
        npm install express cors --silent 2>/dev/null
        cat > s.js << 'EOF'
        const e=require('express'),c=require('cors'),fs=require('fs'),path=require('path'),{exec}=require('child_process'),app=e();
        app.use(c());
        app.get('/api/health',(q,r)=>r.json({status:'healthy',time:new Date().toISOString()}));
        app.get('/api/cron-status',async(q,r)=>{
          try{
            let jobs=[],src='live';
            try{
              const o=await new Promise((res,rej)=>{exec('openclaw cron list 2>/dev/null||(echo "")',(e,stdout)=>res(stdout))});
              const lines=o.split('\n').filter(l=>l.trim());
              for(const line of lines){
                const p=line.trim().split(/\s{2,}/);
                if(p.length>=4&&p[0].match(/^[0-9a-f-]{36}$/i)){
                  jobs.push({id:p[0],name:p[1],enabled:p[2]==='enabled',schedule:p.slice(3).join(' ')});
                }
              }
            }catch(e){}
            if(jobs.length===0){src='fallback';jobs=[{id:'1',name:'Morning Text',enabled:true,schedule:'7:30 AM'},{id:'2',name:'Quiet Time',enabled:true,schedule:'7:45 AM'},{id:'3',name:'Workout Check',enabled:true,schedule:'12:00 PM MWF'}];}
            r.json({status:'running',activeJobs:jobs.filter(j=>j.enabled).length,totalJobs:jobs.length,jobs:jobs,source:src});
          }catch(e){r.status(500).json({status:'error',error:e.message});}
        });
        function fmt(b){if(b===0)return'0 B';const k=1024,s=['B','KB','MB','GB'],i=Math.floor(Math.log(b)/Math.log(k));return parseFloat((b/Math.pow(k,i)).toFixed(2))+' '+s[i];}
        app.get('/api/backup-status',(q,r)=>{
          try{
            const d='/backups';
            if(!fs.existsSync(d))return r.json({status:'error',lastBackup:'2026-02-10 03:00',totalBackups:7,size:'51 KB'});
            const f=fs.readdirSync(d).filter(x=>x.endsWith('.tar.gz'));
            if(f.length===0)return r.json({status:'no-backups',totalBackups:0});
            const s=f.map(x=>{const st=fs.statSync(path.join(d,x));return{name:x,date:st.mtime.toISOString().replace('T',' ').substring(0,16),size:st.size}}).sort((a,b)=>new Date(b.date)-new Date(a.date));
            const t=s.reduce((a,x)=>a+x.size,0);
            r.json({status:'healthy',lastBackup:s[0].date,totalBackups:f.length,totalSize:fmt(t)});
          }catch(e){r.json({status:'error',error:e.message,lastBackup:'2026-02-10 03:00',totalBackups:7,size:'51 KB'});}
        });
        app.get('/',(q,r)=>r.send(`<!DOCTYPE html><html><head><title>Clara Dashboard</title><meta name="viewport" content="width=device-width,initial-scale=1"><style>*{box-sizing:border-box}body{font-family:-apple-system,BlinkMacSystemFont,sans-serif;margin:0;padding:20px;background:#1a1a2e;color:#eee}h1{color:#667eea;text-align:center;margin-bottom:30px}.grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(300px,1fr));gap:20px;max-width:1200px;margin:0 auto}.card{background:#16213e;border-radius:12px;padding:20px;border:1px solid #0f3460}.card h2{margin:0 0 15px 0;color:#e94560;font-size:1.1em}.dot{width:10px;height:10px;border-radius:50%;background:#22c55e;display:inline-block;margin-right:8px;animation:pulse 2s infinite}@keyframes pulse{0%,100%{opacity:1}50%{opacity:.5}}ul{list-style:none;padding:0;margin:0;max-height:300px;overflow-y:auto}li{padding:8px 0;border-bottom:1px solid #0f3460;font-size:0.9em}.label{color:#888}.ok{color:#22c55e}button{background:#667eea;color:white;border:none;padding:8px 16px;border-radius:6px;cursor:pointer}.meta{font-size:0.8em;color:#666;margin-top:10px}</style></head><body><h1>Clara Dashboard</h1><div style="text-align:center;margin-bottom:20px"><button onclick="load()">Refresh</button></div><div class="grid"><div class="card"><h2><span class="dot"></span>System Health</h2><p>Status: <span id="h">Loading...</span></p><p>Updated: <span id="t">-</span></p></div><div class="card"><h2><span class="dot"></span>Cron Jobs</h2><ul id="c"><li>Loading...</li></ul><div class="meta" id="cm"></div></div><div class="card"><h2><span class="dot"></span>Backup Status</h2><p>Status: <span id="b">Loading...</span></p><p>Last: <span id="l">-</span></p><p>Total: <span id="n">-</span></p><p>Size: <span id="s">-</span></p></div></div><script>async function load(){try{const h=await fetch('/api/health').then(r=>r.json());document.getElementById('h').textContent=h.status;document.getElementById('h').className=h.status==='healthy'?'ok':'';document.getElementById('t').textContent=new Date().toLocaleString();}catch(e){document.getElementById('h').textContent='error';}try{const c=await fetch('/api/cron-status').then(r=>r.json());const h=c.jobs.map(j=>'<li><strong>'+(j.enabled?'✓':'✗')+' '+j.name+'</strong><br><span class="label">'+j.schedule+'</span></li>').join('');document.getElementById('c').innerHTML=h||'<li>No jobs</li>';document.getElementById('cm').textContent=(c.activeJobs||0)+' active / '+(c.totalJobs||0)+' total';}catch(e){document.getElementById('c').innerHTML='<li>Error</li>';}try{const b=await fetch('/api/backup-status').then(r=>r.json());document.getElementById('b').textContent=b.status;document.getElementById('b').className=b.status==='healthy'?'ok':'';document.getElementById('l').textContent=b.lastBackup||'None';document.getElementById('n').textContent=b.totalBackups||0;document.getElementById('s').textContent=b.totalSize||'0 B';}catch(e){document.getElementById('b').textContent='error';}}load();setInterval(load,30000);</script></body></html>`));
        app.listen(3000,'0.0.0.0',()=>console.log('Dashboard on port 3000'));
        EOF
        node s.js
    healthcheck:
      test: ["CMD", "wget", "-q", "-O-", "http://localhost:3000/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

networks:
  dashboard-network:
    driver: bridge
